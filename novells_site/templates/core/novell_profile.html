{% extends 'base.html' %}
{% load static %}
{% load user_tags %}
{% block title %}
    {{ novell.rus_title }}
{% endblock %}
{% block styles %}
    <link rel="stylesheet" type="text/css" href="{% static "core/novell_profile.css" %}">
    <style>
        .review-text {
            background-image: linear-gradient(to bottom, rgba(147, 159, 176, 0), #fff);
        }

        .review-text p {
            margin-bottom: 2px;
        }

        .spoiler {
            height: 100px;
            overflow: hidden;
        }

        .ratio-3х4 {
            --aspect-ratio: calc(4 / 3 * 100%);
        }
        .my-buttons .btn {
            margin-left: 10px;
        }
    </style>
{% endblock %}

{% block scripts %}
    <script src="https://cdn.tiny.cloud/1/ucih7y6bf15dmnxjth5y7vhpwc29y07p91usg9pjqivrf2p1/tinymce/5/tinymce.min.js"
            referrerpolicy="origin"></script>
    <script type="text/javascript" src='{% static "core/js/like-dislike.js" %}'></script>

{% endblock %}

{% block content %}
    <div class="container-xxl" style="background:#ffffff;">

        <div class="row mt-2 pt-3 justify-content-center">
            <div class="col-xxl-4 col-md-4 col-md-5 col-sm-10 pr-0">
                <div class="ratio ratio-3х4">

                    <img src="{{ novell.poster.url }}" alt="{{ novell.original_title }}"
                         class="rounded img-thumbnail">
                </div>
            </div>
            <div class="col-xxl-8 col-md-7 col-sm-12">

                <div class="card border-0 h-100">
                    <div class="card-body pt-0">
                        <h2>{{ novell.rus_title }}</h2>
                        <h3>{{ novell.original_title }}</h3>
                        <h4>{{ novell.eng_title }}</h4>

                        <p class="text-muted mb-0 mt-4 font-weight-bold">Автор: <span
                                class="font-weight-bold text-dark">{{ novell.author }}</span></p>

                        <p class="text-muted mb-0 font-weight-bold">Количество глав: <span
                                class="font-weight-bold text-dark">{% if novell.chapter_count %}{{ novell.chapter_count }}{% else %}???{% endif %}</span></p>
                        <p class="text-muted mb-0 font-weight-bold">Переведено глав: <span
                                class="font-weight-bold text-dark">{{ novell.chapters.count }}</span></p>
                        <p class="text-muted mb-0 font-weight-bold">Состояние перевода:
                            {% if novell.status == 'OG' %}
                                <span class="font-weight-bold text-dark"><i
                                        class="bi bi-circle-fill text-primary" style="
    vertical-align: text-top; font-size: 11pt;"></i> Продолжается</span>
                            {% elif novell.status == 'AN' %}
                                <span class="font-weight-bold text-dark"><i
                                        class="bi bi-circle-fill text-danger" style="
    vertical-align: bottom;"></i>
                                    Запланирован</span>
                            {% elif novell.status == 'CT' %}
                                <span class="font-weight-bold text-dark">Завершен</span>
                            {% endif %}
                        </p>
                        <p class="text-muted mb-0 font-weight-bold">Рейтинг:
                            <span class="h6">
                            {% stars novell.overall_rating %}
                            <span class="editContent font-weight-bolder text-dark">{{ novell.overall_rating }}</span>
                        </span>
                        </p>

                        <h5 class="my-2 text-dark">Жанры</h5>
                        {% for genre in novell.genres.all %}
                            <a type="button" class="btn btn-outline-primary" href="{% url 'core:filter' %}?genre={{ genre.id }}">
                                {{ genre }}
                            </a>
                        {% endfor %}

                        {% if user.is_authenticated %}
                            <form action="{% url 'core:add_rating' %}" class="mt-2" method="post" name="rating">
                                <p class="m-0 text-muted font-weight-bold">Ваша оценка: </p>

                                {% csrf_token %}
                                <input type="hidden" value="{{ novell.id }}" name="novell">
                                <span class="rating">
                                {% for k, v in star_form.fields.rate.choices %}
                                    <input id="rating{{ v }}" type="radio" name="rate"
                                           {% if novell|star_user:user == k %}checked{% endif %}
                                           value="{{ k }}">
                                    <label for="rating{{ v }}" style="cursor: pointer;">{{ k }}</label>
                                {% endfor %}
                            </span>


                            </form>
                        {% else %}
                            <p class="text-muted font-weight-bold mt-2">
                                <a data-toggle="modal" data-target="#loginModal"
                                   aria-expanded="false" class="text-primary" style="cursor: pointer;">
                                    Войдите</a>, чтобы оценить</p>

                        {% endif %}
                    </div>
                    <div class="card-footer border-0" style="background-color: white">
                        <div class="row w-100">
                            <div class="col">
                                <div class="d-flex justify-content-start my-buttons">
                                    {% if user.is_authenticated %}
                                        {% if user|novell_unread:novell %}
                                            {% if novell|first_chapter_link == 0 %}
                                                <button type="button" class="btn btn-outline-secondary disabled">
                                                    Пока нет глав
                                                    <i class="bi bi-x-octagon text-danger"></i>
                                                </button>
                                            {% else %}
                                                <a type="button"
                                                   class="btn btn-warning"
                                                   href="{% url 'core:chapter_detail' novell.slug novell|first_chapter_link %}">Начать
                                                    читать</a>
                                            {% endif %}
                                        {% elif user|novell_readed:novell %}
                                            <button type="button" class="btn btn-outline-secondary disabled">Прочитано
                                                <i class="bi bi-patch-check text-success"></i>
                                            </button>
                                        {% else %}
                                            <a type="button" class="btn btn-dark"
                                               href="{% url 'core:chapter_detail' novell.slug user|last_unread_chapter:novell %}">Продолжить
                                                чтение</a>
                                        {% endif %}
                                    {% else %}
                                        {% if novell|first_chapter_link == 0 %}
                                            <button type="button" class="btn btn-outline-secondary disabled">
                                                Пока нет глав
                                                <i class="bi bi-x-octagon text-danger"></i>
                                            </button>
                                        {% else %}
                                            <a type="button"
                                               class="btn btn-warning"
                                               href="{% url 'core:chapter_detail' novell.slug novell|first_chapter_link %}">Начать
                                                читать</a>
                                        {% endif %}

                                    {% endif %}
                                    {% if user.is_authenticated %}


                                        {% if novell in user.user_profile.bookmarks.all %}
                                            <a href="{% url 'core:del_from_bookmarks' novell.id 'bookmark' 'novell' %}"
                                               type="button"
                                               class="btn btn-outline-warning">В избранном <i
                                                    class="bi bi-x-square-fill text-danger"></i>
                                            </a>
                                        {% elif novell in user.user_profile.planned.all %}
                                            <a href="{% url 'core:del_from_bookmarks' novell.id 'planned' 'novell' %}"
                                               type="button"
                                               class="btn btn-outline-secondary">Запланированно <i
                                                    class="bi bi-x-square-fill text-danger"></i>
                                            </a>
                                        {% else %}

                                            <button class="btn btn-info dropdown-toggle" type="button"
                                                    data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-bookmark-check-fill text-success"></i> Добавить в
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li>

                                                    <a class="dropdown-item"
                                                       href="{% url 'core:add_to_bookmarks' novell.id 'bookmark' %}">
                                                        <div class="d-flex justify-content-between">
                                                            <span>Избранное</span>
                                                            <i class="bi bi-bookmark-star text-warning"></i>
                                                        </div>
                                                    </a>
                                                </li>
                                                <li>

                                                    <a class="dropdown-item"
                                                       href="{% url 'core:add_to_bookmarks' novell.id 'planned' %}">
                                                        <div class="d-flex justify-content-between">
                                                            <span class="mr-2">Запланированное</span>
                                                            <i class="bi bi-calendar-event text-primary"></i>

                                                        </div>
                                                    </a>
                                                </li>
                                                <li>

                                                    {% if user|user_already_read:novell %}
                                                        <a class="dropdown-item"
                                                           href="{% url 'core:del_from_bookmarks' novell.id 'readed' 'novell' %}">
                                                            <div class="d-flex justify-content-between">
                                                                <span>Прочитано</span>
                                                                <i class="bi bi-check-circle-fill text-success"></i>
                                                            </div>
                                                        </a>
                                                    {% else %}
                                                        <a class="dropdown-item"
                                                           href="{% url 'core:add_to_bookmarks' novell.id 'readed' %}">
                                                            <div class="d-flex justify-content-between">
                                                                <span>Прочитано</span>
                                                                <i class="bi bi-x text-danger"></i>
                                                            </div>
                                                        </a>
                                                    {% endif %}
                                                </li>
                                            </ul>

                                        {% endif %}
                                    {% else %}
                                        <a class="btn btn-info dropdown-toggle" data-toggle="modal"
                                           data-target="#loginModal" type="button" aria-expanded="false">
                                            <i class="bi bi-bookmark-check-fill text-success"></i> Добавить в
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="row">
            <ul class="nav nav-tabs ml-0" id="myTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active h5" id="description-tab" data-toggle="tab" href="#description" role="tab"
                       aria-controls="home" aria-selected="true"><i class="bi bi-info"
                                                                    style="vertical-align: bottom"></i> Информация</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link h5" id="list-tab" data-toggle="tab" href="#list" role="tab"
                       aria-controls="profile" aria-selected="false"><i class="bi bi-list-ol"
                                                                        style="vertical-align: bottom"></i>
                        Оглавление</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link h5" id="comments-tab" data-toggle="tab" href="#comments" role="tab"
                       aria-controls="profile" aria-selected="false"><i class="bi bi-chat"
                                                                        style="vertical-align: bottom"></i> <span style="vertical-align: bottom;">Отзывы</span><span
                            class="badge bg-secondary ml-1">{{ novell.reviews_to_novell.count }}</span></a>
                </li>
            </ul>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="tab-content profile-tab" id="myTabContent">
                    <div class="tab-pane fade show active" id="description" role="tabpanel"
                         aria-labelledby="description-tab">

                        <div class="card mt-2">
                            <div class="card-body">
                                <h3 class="mb-2">Описание</h3>
                                <p class="description">
                                    {{ novell.description|safe|linebreaksbr }}
                                </p>

                            </div>
                        </div>


                    </div>

                    <div class="tab-pane fade" id="list" role="tabpanel" aria-labelledby="list-tab">
                        <div class="list-group mt-2">

                            {% for n in novell.chapters.all %}
                                <a href="{{ n.get_absolute_url }}"
                                   class="list-group-item list-group-item-action
                                    {% if not n.status %}list-group-item-danger disabled{% else %}list-group-item-warning{% endif %}">
                                    <div class="d-flex justify-content-between">
                                        <span class="h5 mb-0" style="color: #533f03">
                                            {{ n.title }}
                                            {% if not n.status %}
                                                <span class="small">
                                                <i class="bi bi-circle-fill text-danger"
                                                   style="vertical-align: bottom;"></i>
                                                Анонос
                                                </span>
                                            {% endif %}
                                        </span>
                                        <span class="text-muted"><small>{{ n.publish|date }}</small></span>
                                    </div>

                                </a>



                            {% endfor %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="comments" role="tabpanel" aria-labelledby="comments-tab">
                        <div class="container">
                            <div class="row justify-content-center">
                                <div class="col-11">
                                    {% if novell.reviews_to_novell.count == 0 %}
                                        <div class="card my-3 py-3">
                                            <div class="h4 text-center my-2">Здесь пока нет отзывов к новелле
                                                «{{ novell }}»,
                                                хотите написать?
                                            </div>
                                            <div class="text-center">
                                                {% if user.is_authenticated %}
                                                    <span class="btn btn-success" style="cursor: pointer;"
                                                          data-bs-toggle="modal"
                                                          data-bs-target="#reviewModal">
                                                    <i class="bi bi-pencil"></i>
                                                    Написать отзыв
                                                </span>
                                                {% else %}
                                                    <span class="btn btn-success" style="cursor: pointer;"
                                                          data-toggle="modal" data-target="#loginModal">
                                                    <i class="bi bi-pencil"></i>
                                                    Написать отзыв
                                                </span>
                                                {% endif %}
                                            </div>

                                        </div>
                                    {% else %}
                                        <div class="d-flex justify-content-between mt-3">
                                            <div><span class="h3"> Отзывы к новелле</span> <span
                                                    class="small"
                                                    style="vertical-align: top;">{{ novell.reviews_to_novell.count }}</span>
                                            </div>
                                            <div class="text-center">
                                                {% if user.is_authenticated and not user|user_already_rate:novell %}
                                                    <span class="btn btn-success" style="cursor: pointer;"
                                                          data-bs-toggle="modal"
                                                          data-bs-target="#reviewModal">
                                                    <i class="bi bi-pencil"></i>
                                                    Написать отзыв
                                                </span>
                                                {% elif not user.is_authenticated %}
                                                    <span class="btn btn-success" style="cursor: pointer;"
                                                          data-toggle="modal" data-target="#loginModal">
                                                    <i class="bi bi-pencil"></i>
                                                    Написать отзыв
                                                </span>
                                                {% elif user|user_already_rate:novell %}
                                                    <span class="btn btn-success disabled" style="cursor: pointer;"
                                                          data-bs-toggle="modal"
                                                          data-bs-target="#reviewModal">
                                                    <i class="bi bi-pencil"></i>
                                                    Вы уже оставили отзыв
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% for rev in novell.reviews_to_novell.all %}
                                            <div class="card my-3">
                                                <div class="card-header">
                                                    <div class="d-flex">
                                                        <div class="flex-shrink-0 py-3 mr-3">
                                                            <img src="{{ rev.author.user_profile.avatar.url }}"
                                                                 alt="{{ rev.author }}" width="60" height="60"
                                                                 style="border-radius: 50%;">
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            <p class="my-0 h6">{{ rev.title }}</p>
                                                            <p class="my-0">{% stars novell|star_user:rev.author %}</p>
                                                            <p class="my-0"><a
                                                                    href="{{ rev.author.user_profile.get_absolute_url }}">{{ rev.author }}</a>
                                                            </p>
                                                            <p class="small my-0">{{ rev.created|date }}</p>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="card-body review-text">
                                                    {{ rev.body|safe }}
                                                    <!--
                                                    <div class="d-flex justify-content-center">
                                                        <button class="show-hide button btn btn-light">Показать всё
                                                        </button>
                                                    </div>
                                                       -->
                                                </div>

                                                <div class="card-footer">
                                                    Понравился отзыв?

                                                    {% include 'core/include/like_dislike_panel_for_review.html' %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel"
                                 aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="reviewModalLabel">Отзыв к {{ novell }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <form method="POST" id="add-review">
                                            <div class="modal-body">

                                                {% csrf_token %}

                                                <div class="mb-3">
                                                    <label for="recipient-name"
                                                           class="col-form-label">Заголовок:</label>
                                                    <input type="text" class="form-control" name="title" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="message-text" class="col-form-label">Отзыв:</label>
                                                    <textarea class="form-control" name="body"></textarea>
                                                </div>

                                            </div>
                                            <div class="modal-footer">
                                                <input type="submit"
                                                       class="btn btn-primary" value="Оставить отзыв">
                                                </input>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="{% static "core/js/star_rating.js" %}"></script>

    <script>
        tinymce.init({
            selector: 'textarea',
            menubar: false,
            height: 500,
            plugins: [
                'advlist autolink lists link image charmap print preview anchor',
                'searchreplace visualblocks code fullscreen',
                'insertdatetime media table paste code help wordcount'
            ],
            toolbar: 'bold italic backcolor',
            content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px }'
        });

        // Returns text statistics for the specified editor by id


    </script>
    <script>

        function submitForm() {
            // Check if the user has entered less than 1000 characters
            if (getStats('textarea').chars < 1000) {
                alert("You need to enter 1000 characters or more.");
                return;
            }

            // Check if the user has entered less than 100 words
            if (getStats('textarea').words < 100) {
                alert("You need to enter 100 words or more.");
                return;
            }

            // Submit the form
            document.forms[0].submit();
        }


        function getStats(id) {
            var body = tinymce.get(id).getBody(), text = tinymce.trim(body.innerText || body.textContent);

            return {
                chars: text.length,
                words: text.split(/[\w\u2019\'-]+/).length
            };
        }
    </script>
    <script>
        var halfText = $('.spoiler').innerHeight() / 2,
            textHeight = $('.spoiler').innerHeight();

        $('.spoiler').css('height', $('.spoiler').innerHeight() / 2);

        $('.show-hide').click(function () {
            if ($('.spoiler').innerHeight() == halfText) {
                $('.spoiler').animate({height: textHeight}, 500);
                $(this).text('Скрыть');
            } else {
                $('.spoiler').animate({height: halfText}, 500);
                $(this).text('Показать');
            }
        });
    </script>
    <script>
        $('#add-review').submit(function () {
            $(this).find(':input[type=submit]').prop('disabled', true);
        });
    </script>
{% endblock %}